<!DOCTYPE html>
<html>

<head>
  <title>Posts</title>
  <script src="resources/js/jquery-3.2.1.min.js"></script>
  <link rel="stylesheet" href="resources/css/bootstrap.min.css">
  <link rel="stylesheet" href="resources/css/bootstrap.css">

  <script>
    function agregarPost(postData) {
      var rowpost = "<tr>" + "<td>" + "<div class='panel panel-danger'>"
        + "<div class='table table-striped'>"  
        + "<span class=''></span>" + "<a href=''>" + postData.title + "</a>" + "</div>"
        + "<div class='table table-striped'>" + postData.body + "</div>"
        + "<div class='table table-striped'>" + "<a href='datosusuario.html?id=" + postData.id +"&name= "+ postData.name+"'>" + postData.name + "</a>" + "    "+postData.email + "</div>" +
        "</div>" + "</td>" + "</tr>";
      $("table tbody").append(rowpost);
    };
    
    function guardarDb(usuario) {
      var usuarios = [];
      myStorage = window.localStorage;
      var dbUsuarios = myStorage.getItem("usuarios");
      if (dbUsuarios != null) {
        usuarios = JSON.parse(dbUsuarios)
      }
      usuarios.push(usuario);
      myStorage.setItem("usuarios", JSON.stringify(usuarios));
    };

    function guardarFav(fvpost) {
      var postfv = [];
      myStorage = window.localStorage;
      var dbFavoritos = myStorage.getItem("Favoritos");
      if (dbFavoritos != null) {
        postfv = JSON.parse(dbFavoritos)      
}
      postfv.push(fvpost);
      myStorage.setItem("Favoritos", JSON.stringify(postfv));
    }

    function traerTodosLosUsuarios(root)
    {
      $.ajax({
        url: root + '/users',
        method: 'GET'
      }).then(function (usuarios) {
        $.each(usuarios, function (index, user) {
          guardarDb(user);
        });
        traerTodosLosPosts(root, usuarios);
      });
    }

    function traerTodosLosPosts(root, usuarios)
    {
      $.ajax({
        url: root + '/posts',
        method: 'GET'
      }).then(function (response) {
        var postDataArray = [];
        $.each(response, function(index, post){
          $.each(usuarios, function(indexUsuario, usuario){
            if(usuario.id === post.userId)
            {
              var postData = {
                userId: usuario.id,
                id: post.id,
                name: usuario.name,
                email: usuario.email,
                title: post.title,
                body: post.body,
                address: post.address
              }
              agregarPost(postData);
              postDataArray.push(postData);
              
            }  
          });       
        });
        window.localStorage.setItem("DatosDelPost", JSON.stringify(postDataArray));
      });
    }

    $(document).ready(function () {
      var root = 'https://jsonplaceholder.typicode.com';
      traerTodosLosUsuarios(root);

     
     
    });
    
   
  </script>
</head>

<body>
  <form>
    <div class="panel panel-default">
      <div class="panel-heading">postS</div>
      <div style="margin-left: 10%; margin-right: 10%; margin-top: 70px;">
        <table>
          <tr>

          </tr>

        </table>
      </div>
    </div>
  </form>
</body>
</html>